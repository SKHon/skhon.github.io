<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>探索garfish源码 | SKHon的随笔</title><meta name="description" content="准备工作首先，可以在github上把代码拉到本地，地址为：https://github.com/modern-js-dev/garfish然后就需要把项目跑起来，方便调试。总共四步即可：  全局安装pnpm： $ npm i -g pnpm   安装依赖 $ pnpm install   启动build:watch $ pnpm build:watch   启动dev $ pnpm dev这样就跑"><meta name="keywords" content="Web"><meta property="og:type" content="article"><meta property="og:title" content="探索garfish源码"><meta property="og:url" content="https://skhon.github.io/2021/12/28/fe/garfish/index.html"><meta property="og:site_name" content="前端架构之路"><meta property="og:description" content="准备工作首先，可以在github上把代码拉到本地，地址为：https://github.com/modern-js-dev/garfish然后就需要把项目跑起来，方便调试。总共四步即可：  全局安装pnpm： $ npm i -g pnpm   安装依赖 $ pnpm install   启动build:watch $ pnpm build:watch   启动dev $ pnpm dev这样就跑"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2021-12-28T12:40:40.133Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="探索garfish源码"><meta name="twitter:description" content="准备工作首先，可以在github上把代码拉到本地，地址为：https://github.com/modern-js-dev/garfish然后就需要把项目跑起来，方便调试。总共四步即可：  全局安装pnpm： $ npm i -g pnpm   安装依赖 $ pnpm install   启动build:watch $ pnpm build:watch   启动dev $ pnpm dev这样就跑"><link rel="canonical" href="https://skhon.github.io/2021/12/28/fe/garfish/index.html"><link rel="alternate" href="/atom.xml" title="前端架构之路" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/skhon" target="_blank"><img class="img-circle img-rotate" src="/images/my.png" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">SKHon</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Software Engineer</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> 北京</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-books"><a href="/books"><i class="icon icon-book-fill"></i> <span class="menu-title">书单</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><im>字节内推：<a>https://job.toutiao.com/s/RKVfgX2</a></im></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工程化建设/">工程化建设</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/面试/">面试</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Architecture/">Architecture</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Engineering/">Engineering</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Interview/">Interview</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/">Security</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Talking-to-oneself/">Talking to oneself</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Architecture/" style="font-size:13px">Architecture</a> <a href="/tags/Engineering/" style="font-size:13px">Engineering</a> <a href="/tags/Interview/" style="font-size:13px">Interview</a> <a href="/tags/Security/" style="font-size:13px">Security</a> <a href="/tags/Talking-to-oneself/" style="font-size:14px">Talking to oneself</a> <a href="/tags/Web/" style="font-size:14px">Web</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/杂谈/">杂谈</a></p><p class="item-title"><a href="/2022/01/07/my-heart/yongzhengwangchao/" class="title">搭一个小窝</a></p><p class="item-date"><time datetime="2022-01-07T09:23:34.732Z" itemprop="datePublished">2022-01-07</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/前端/">前端</a></p><p class="item-title"><a href="/2021/12/28/fe/typescript/" class="title">typescript整理</a></p><p class="item-date"><time datetime="2021-12-28T10:16:41.992Z" itemprop="datePublished">2021-12-28</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/前端/">前端</a></p><p class="item-title"><a href="/2021/12/28/fe/garfish/" class="title">探索garfish源码</a></p><p class="item-date"><time datetime="2021-12-28T09:21:46.644Z" itemprop="datePublished">2021-12-28</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/架构/">架构</a></p><p class="item-title"><a href="/2021/12/20/architecture/base/" class="title">架构师的职责</a></p><p class="item-date"><time datetime="2021-12-20T13:07:00.774Z" itemprop="datePublished">2021-12-20</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/面试/">面试</a></p><p class="item-title"><a href="/2021/12/17/interview/mymind/" class="title">谈谈我喜欢的候选人</a></p><p class="item-date"><time datetime="2021-12-17T08:42:03.628Z" itemprop="datePublished">2021-12-17</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#准备工作"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#在主应用中引入Garfish实例："><span class="toc-number">2.</span> <span class="toc-text">在主应用中引入Garfish实例：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#主应用中启动Garfish"><span class="toc-number">3.</span> <span class="toc-text">主应用中启动Garfish</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#路由trigger子应用"><span class="toc-number">4.</span> <span class="toc-text">路由trigger子应用</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-fe/garfish" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">探索garfish源码</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2021/12/28/fe/garfish/" class="article-date"><time datetime="2021-12-28T09:21:46.644Z" itemprop="datePublished">2021-12-28</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/前端/">前端</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/Web/">Web</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/2021/12/28/fe/garfish/" class="leancloud_visitors" data-flag-title="探索garfish源码"><span class="leancloud-visitors-count">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/12/28/fe/garfish/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>首先，可以在github上把代码拉到本地，地址为：<a href="https://github.com/modern-js-dev/garfish" target="_blank" rel="noopener">https://github.com/modern-js-dev/garfish</a><br>然后就需要把项目跑起来，方便调试。总共四步即可：</p><ol><li>全局安装pnpm：<blockquote><p>$ npm i -g pnpm</p></blockquote></li><li>安装依赖<blockquote><p>$ pnpm install</p></blockquote></li><li>启动build:watch<blockquote><p>$ pnpm build:watch</p></blockquote></li><li>启动dev<blockquote><p>$ pnpm dev<br>这样就跑起来了。整体框架代码讲解主要以流程为主，一些细节性逻辑就直接跳过，有兴趣的同学可以翻源码。</p></blockquote><h1 id="在主应用中引入Garfish实例："><a href="#在主应用中引入Garfish实例：" class="headerlink" title="在主应用中引入Garfish实例："></a>在主应用中引入Garfish实例：</h1>在主应用中，首先引入Garfish实例：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// dev/main/src/index.ts</span><br><span class="line">import GarfishInstance from &apos;garfish&apos;;</span><br></pre></td></tr></table></figure></li></ol><p>先看一下这个实例是个啥，追溯一下源码，发现Garfish实例是一个函数返回的：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// packages/garfish/src/index.ts</span><br><span class="line">function createContext(): Garfish &#123;</span><br><span class="line">  // ...</span><br><span class="line">  // Existing garfish instance, direct return</span><br><span class="line">  if (inBrowser() &amp;&amp; window[&apos;__GARFISH__&apos;] &amp;&amp; window[&apos;Garfish&apos;]) &#123;</span><br><span class="line">    return window[&apos;Garfish&apos;];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const GarfishInstance = new Garfish(&#123;</span><br><span class="line">    plugins: [GarfishRouter(), GarfishBrowserVm(), GarfishBrowserSnapshot()],</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // ...</span><br><span class="line">  </span><br><span class="line">  return GarfishInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>createContext可以理解为创建上下文环境，从上至下捋一下，如果是浏览器环境，并且window上存在Garfish对象，则直接返回（熟悉设计模式的同学，应该知道这是一个单例模式）。接下来new了一个Garfish对象，并且默认传入了一个对象 { plugins: [GarfishRouter(), GarfishBrowserVm(), GarfishBrowserSnapshot()] }。这是初始化了三个插件，我们继续看一下这三个插件长什么样子。<br>我们先看一下GarfishRouter<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// packages/router/src/index.ts</span><br><span class="line">export function GarfishRouter(_args?: Options) &#123;</span><br><span class="line">  return function (Garfish: interfaces.Garfish): interfaces.Plugin &#123;</span><br><span class="line">    Garfish.apps = &#123;&#125;;</span><br><span class="line">    Garfish.router = router;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      name: &apos;router&apos;,</span><br><span class="line">      version: __VERSION__,</span><br><span class="line"></span><br><span class="line">      bootstrap(options: interfaces.Options) &#123;</span><br><span class="line">        // ...</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      registerApp(appInfos) &#123;</span><br><span class="line">        // ...</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看到GarfishRouter()返回的是一个function，形成闭包，最后会返回一个对象。这个对象其实是一个插件的格式，有name、version，还有生命周期钩子bootstrap、registerApp，生命周期钩子我们后续会介绍到，这里大家了解就行。再看看其他两个插件是什么：<br>GarfishBorwserVm:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// packages/browser-vm/src/pluginify.ts</span><br><span class="line">export function GarfishBrowserVm() &#123;</span><br><span class="line">  return function (Garfish: interfaces.Garfish): interfaces.Plugin &#123;</span><br><span class="line">    Garfish.getGlobalObject = function () &#123;</span><br><span class="line">      return Sandbox.getNativeWindow();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Garfish.setGlobalValue = function (key, value) &#123;</span><br><span class="line">      return (this.getGlobalObject()[key] = value);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Garfish.clearEscapeEffect = function (key, value) &#123;</span><br><span class="line">      const global = this.getGlobalObject();</span><br><span class="line">      if (key in global) &#123;</span><br><span class="line">        global[key] = value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    return createOptions(Garfish);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function createOptions(Garfish: interfaces.Garfish) &#123;</span><br><span class="line">  // ...</span><br><span class="line">  const options: interfaces.Plugin = &#123;</span><br><span class="line">    name: &apos;browser-vm&apos;,</span><br><span class="line">    version: __VERSION__,</span><br><span class="line"></span><br><span class="line">    afterLoad(appInfo, appInstance) &#123;</span><br><span class="line">      // ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // If the app is uninstalled, the sandbox needs to clear all effects and then reset</span><br><span class="line">    afterUnmount(appInfo, appInstance, isCacheMode) &#123;</span><br><span class="line">      // ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    afterMount(appInfo, appInstance) &#123;</span><br><span class="line">      // ...</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  return options;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>GarfishBrowserSnapshot:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// packages/browser-snapshot/src/index.ts</span><br><span class="line">export function GarfishBrowserSnapshot(op?: BrowserConfig) &#123;</span><br><span class="line">  return function (Garfish: interfaces.Garfish): interfaces.Plugin &#123;</span><br><span class="line">    const config: BrowserConfig = op || &#123; open: true &#125;;</span><br><span class="line"></span><br><span class="line">    const options = &#123;</span><br><span class="line">      openBrowser: false,</span><br><span class="line">      version: __VERSION__,</span><br><span class="line">      name: &apos;browser-snapshot&apos;,</span><br><span class="line"></span><br><span class="line">      afterLoad(appInfo, appInstance) &#123;</span><br><span class="line">        // ...</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      beforeMount(appInfo, appInstance) &#123;</span><br><span class="line">        // ...</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      afterUnmount(appInfo, appInstance) &#123;</span><br><span class="line">        // ...</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    return options;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看到都是返回一个函数，并且这个函数的返回格式有点类似，其实这就是garfish插件的形式，返回一个函数，该函数返回一个对象，这个对象包含了这个插件的一些信息，可以总结成这样：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name: &apos;&apos;,</span><br><span class="line">    version: &apos;&apos;,</span><br><span class="line">    lifecycle: &apos;&apos; // 这里的lifecycle是泛指生命周期的钩子函数，具体指bootstrap、beforeBootstrap等等</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>插件中生命周期的具体实现，放在后面讲述。这里暂时把代码运行链路拉通。接下来再返回Garfish类的实现，它的实例是什么样子的。<br>Garfish类的实现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/garfish.ts</span><br><span class="line">export class Garfish extends EventEmitter2 &#123;</span><br><span class="line">  public running = false;</span><br><span class="line">  public version = __VERSION__;</span><br><span class="line">  public flag = __GARFISH_FLAG__; // A unique identifier</span><br><span class="line">  public loader = new Loader();</span><br><span class="line">  public hooks = globalLifecycle();</span><br><span class="line">  public channel = new EventEmitter2();</span><br><span class="line">  public options = createDefaultOptions();</span><br><span class="line">  public externals: Record&lt;string, any&gt; = &#123;&#125;;</span><br><span class="line">  public activeApps: Array&lt;interfaces.App&gt; = [];</span><br><span class="line">  public plugins: interfaces.Plugins = &#123;&#125; as any;</span><br><span class="line">  public cacheApps: Record&lt;string, interfaces.App&gt; = &#123;&#125;;</span><br><span class="line">  public appInfos: Record&lt;string, interfaces.AppInfo&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  private nestedSwitch = false;</span><br><span class="line">  private loading: Record&lt;string, Promise&lt;any&gt; | null&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  get props(): Record&lt;string, any&gt; &#123;</span><br><span class="line">    return (this.options &amp;&amp; this.options.props) || DEFAULT_PROPS.get(this);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  constructor(options: interfaces.Options) &#123;</span><br><span class="line">    super();</span><br><span class="line">    this.setOptions(options);</span><br><span class="line">    DEFAULT_PROPS.set(this, &#123;&#125;);</span><br><span class="line">    this.options.plugins?.forEach((plugin) =&gt; this.usePlugin(plugin));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private setOptions(options: Partial&lt;interfaces.Options&gt;) &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createPluginSystem&lt;T extends (api: typeof HOOKS_API) =&gt; any&gt;(callback: T) &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  usePlugin(</span><br><span class="line">    plugin: (context: Garfish) =&gt; interfaces.Plugin,</span><br><span class="line">    ...args: Array&lt;any&gt;</span><br><span class="line">  ) &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run(options: interfaces.Options = &#123;&#125;) &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  registerApp(list: interfaces.AppInfo | Array&lt;interfaces.AppInfo&gt;) &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setExternal(nameOrExtObj: string | Record&lt;string, any&gt;, value?: any) &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  async loadApp(</span><br><span class="line">    appName: string,</span><br><span class="line">    optionsOrUrl?: Omit&lt;interfaces.AppInfo, &apos;name&apos;&gt;,</span><br><span class="line">  ): Promise&lt;interfaces.App | null&gt; &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>先看一下钩子函数中，做了什么：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/garfish.ts</span><br><span class="line">constructor(options: interfaces.Options) &#123;</span><br><span class="line">    super();</span><br><span class="line">    // 传入的options（其实就是默认的那三个插件） 深度merge到默认的options上。</span><br><span class="line">    this.setOptions(options);</span><br><span class="line">    DEFAULT_PROPS.set(this, &#123;&#125;);</span><br><span class="line">    // 这里分别执行默认的三个插件</span><br><span class="line">    this.options.plugins?.forEach((plugin) =&gt; this.usePlugin(plugin));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>this.setOptions(options)主要是把传入的options深度merge到默认的options中。而传入的options就是传入的那三个默认插件。我们看一下默认的options有哪些属性吧：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/config.ts</span><br><span class="line">export const createDefaultOptions = (nested = false) =&gt; &#123;</span><br><span class="line">  const config: interfaces.Options = &#123;</span><br><span class="line">    // global config</span><br><span class="line">    appID: &apos;&apos;,</span><br><span class="line">    apps: [],</span><br><span class="line">    autoRefreshApp: true,</span><br><span class="line">    disableStatistics: false,</span><br><span class="line">    disablePreloadApp: false,</span><br><span class="line">    // app config</span><br><span class="line">    basename: &apos;/&apos;,</span><br><span class="line">    props: &#123;&#125;,</span><br><span class="line">    // Use an empty div by default</span><br><span class="line">    domGetter: () =&gt; document.createElement(&apos;div&apos;),</span><br><span class="line">    sandbox: &#123;</span><br><span class="line">      snapshot: false,</span><br><span class="line">      disableWith: false,</span><br><span class="line">      strictIsolation: false,</span><br><span class="line">    &#125;,</span><br><span class="line">    // global hooks</span><br><span class="line">    beforeLoad: () =&gt; &#123;&#125;,</span><br><span class="line">    afterLoad: () =&gt; &#123;&#125;,</span><br><span class="line">    errorLoadApp: (e) =&gt; error(e),</span><br><span class="line">    // Router</span><br><span class="line">    onNotMatchRouter: () =&gt; &#123;&#125;,</span><br><span class="line">    // app hooks</span><br><span class="line">    // Code eval hooks</span><br><span class="line">    beforeEval: () =&gt; &#123;&#125;,</span><br><span class="line">    afterEval: () =&gt; &#123;&#125;,</span><br><span class="line">    // App mount hooks</span><br><span class="line">    beforeMount: () =&gt; &#123;&#125;,</span><br><span class="line">    afterMount: () =&gt; &#123;&#125;,</span><br><span class="line">    beforeUnmount: () =&gt; &#123;&#125;,</span><br><span class="line">    afterUnmount: () =&gt; &#123;&#125;,</span><br><span class="line">    // Error hooks</span><br><span class="line">    errorMountApp: (e) =&gt; error(e),</span><br><span class="line">    errorUnmountApp: (e) =&gt; error(e),</span><br><span class="line">    customLoader: null, // deprecated</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  if (nested) &#123;</span><br><span class="line">    invalidNestedAttrs.forEach((key) =&gt; delete config[key]);</span><br><span class="line">  &#125;</span><br><span class="line">  return config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>再回到构造函数中，接下来分别对plugins进行usePlugin操作，其实就是为了拿到插件中的一些属性，并且进行一些注册操作。我们看一下usePlugin做了些什么：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/garfish.ts</span><br><span class="line">usePlugin(</span><br><span class="line">    plugin: (context: Garfish) =&gt; interfaces.Plugin,</span><br><span class="line">    ...args: Array&lt;any&gt;</span><br><span class="line">  ) &#123;</span><br><span class="line">   // ...</span><br><span class="line">   </span><br><span class="line">    // this指向是Garfish类</span><br><span class="line">    args.unshift(this); </span><br><span class="line">    </span><br><span class="line">    // 执行传入的plugin</span><br><span class="line">    const pluginConfig = plugin.apply(null, args) as interfaces.Plugin;</span><br><span class="line">    assert(pluginConfig.name, &apos;The plugin must have a name.&apos;);</span><br><span class="line"></span><br><span class="line">    // 如果没有注册过，则进行注册 </span><br><span class="line">    if (!this.plugins[pluginConfig.name]) &#123;</span><br><span class="line">      this.plugins[pluginConfig.name] = pluginConfig;</span><br><span class="line">      // Register hooks, Compatible with the old api</span><br><span class="line">      this.hooks.usePlugin(pluginConfig);</span><br><span class="line">    &#125; else if (__DEV__) &#123;</span><br><span class="line">      warn(&apos;Please do not register the plugin repeatedly.&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>args数组首位是Garfish自己，然后获取插件配置，前面我们提到了，插件最后的返回是一个对象，里面包含name、version、生命周期钩子等。然后plugin.apply()就是返回的这些配置，并且赋值给了pluginConfig。接下来就是注册逻辑了，如果之前没有注册过该plugin，则进行注册，就是key为plugin的name，value为具体的配置形式，放在this.plugins对象中，这个好理解，接下来是进行this.hooks.usePlugin(pluginConfig)操作，这个其实是用来注册生命周期的，看一下this.hooks是啥，再构造函数中，是这么初始化hooks的：<br>// packages/core/src/garfish.ts<br>public hooks = globalLifecycle();<br>通过函数名，也应该能猜得到，全局生命周期的hooks。接着看globalLifeCycle实现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/lifecycle.ts</span><br><span class="line">export function globalLifecycle() &#123;</span><br><span class="line">  return new PluginSystem(&#123;</span><br><span class="line">    beforeBootstrap: new SyncHook&lt;[interfaces.Options], void&gt;(),</span><br><span class="line">    bootstrap: new SyncHook&lt;[interfaces.Options], void&gt;(),</span><br><span class="line">    beforeRegisterApp: new SyncHook&lt;[interfaces.AppInfo | Array&lt;interfaces.AppInfo&gt;], void&gt;(),</span><br><span class="line">    registerApp: new SyncHook&lt;[Record&lt;string, interfaces.AppInfo&gt;], void&gt;(),</span><br><span class="line">    beforeLoad: new AsyncHook&lt;[interfaces.AppInfo], Promise&lt;boolean | void&gt; | void | boolean&gt;(),</span><br><span class="line">    afterLoad: new AsyncHook&lt;[interfaces.AppInfo, interfaces.App], void&gt;(),</span><br><span class="line">    errorLoadApp: new SyncHook&lt;[Error, interfaces.AppInfo], void&gt;(),</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>返回的是一个pluginSystem实例，传入一个对象，包含7个生命周期属性。先看pluginSystem类的实现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">// packages/hooks/src/pluginSystem.ts</span><br><span class="line">export class PluginSystem&lt;T extends Record&lt;string, any&gt;&gt; &#123;</span><br><span class="line">  lifecycle: T;</span><br><span class="line">  lifecycleKeys: Array&lt;keyof T&gt;;</span><br><span class="line">  private registerPlugins: Record&lt;string, Plugin&lt;T&gt;&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  constructor(lifecycle: T) &#123;</span><br><span class="line">    /*</span><br><span class="line">      lifecycle: </span><br><span class="line">      &#123;</span><br><span class="line">        beforeBootstrap: new SyncHook&lt;[interfaces.Options], void&gt;(),</span><br><span class="line">        bootstrap: new SyncHook&lt;[interfaces.Options], void&gt;(),</span><br><span class="line">        beforeRegisterApp: new SyncHook&lt;[interfaces.AppInfo | Array&lt;interfaces.AppInfo&gt;], void&gt;(),</span><br><span class="line">        registerApp: new SyncHook&lt;[Record&lt;string, interfaces.AppInfo&gt;], void&gt;(),</span><br><span class="line">        beforeLoad: new AsyncHook&lt;[interfaces.AppInfo], Promise&lt;boolean | void&gt; | void | boolean&gt;(),</span><br><span class="line">        afterLoad: new AsyncHook&lt;[interfaces.AppInfo, interfaces.App], void&gt;(),</span><br><span class="line">        errorLoadApp: new SyncHook&lt;[Error, interfaces.AppInfo], void&gt;(),</span><br><span class="line">      &#125;</span><br><span class="line">    */</span><br><span class="line">    this.lifecycle = lifecycle;</span><br><span class="line">    this.lifecycleKeys = Object.keys(lifecycle);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  usePlugin(plugin: Plugin&lt;T&gt;) &#123;</span><br><span class="line">    assert(isPlainObject(plugin), &apos;Invalid plugin configuration.&apos;);</span><br><span class="line">    // Plugin name is required and unique</span><br><span class="line">    const pluginName = plugin.name;</span><br><span class="line">    assert(pluginName, &apos;Plugin must provide a name.&apos;);</span><br><span class="line"></span><br><span class="line">    if (!this.registerPlugins[pluginName]) &#123;</span><br><span class="line">      this.registerPlugins[pluginName] = plugin;</span><br><span class="line"></span><br><span class="line">      for (const key in this.lifecycle) &#123;</span><br><span class="line">        const pluginLife = plugin[key as string];</span><br><span class="line">        if (pluginLife) &#123;</span><br><span class="line">          // Differentiate different types of hooks and adopt different registration strategies</span><br><span class="line">          this.lifecycle[key].on(pluginLife);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (__DEV__) &#123;</span><br><span class="line">      warn(`Repeat to register plugin hooks &quot;$&#123;pluginName&#125;&quot;.`);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removePlugin(pluginName: string) &#123;</span><br><span class="line">    assert(pluginName, &apos;Must provide a name.&apos;);</span><br><span class="line">    const plugin = this.registerPlugins[pluginName];</span><br><span class="line">    assert(plugin, `plugin &quot;$&#123;pluginName&#125;&quot; is not registered.`);</span><br><span class="line"></span><br><span class="line">    for (const key in plugin) &#123;</span><br><span class="line">      this.lifecycle[key].remove(plugin[key as string]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看到上面提到的this.hooks.usePlugin其实是执行了pluginSystem类中的usePlugin方法，实现逻辑也是会在pluginSystem类中的registerPlugins进行注册，然后会在全局生命周期的不同钩子上，注册每个插件配置中对应的钩子函数。这个大家需要好好理解一下，这个设计我们在写自己的框架时可以学习一下。再返回到创建pluginSystem实例中，传入的几个hooks，主要包含两种，一种是同步的SyncHook，另一种是异步的AsyncHook。看一下这两类hooks的实现。<br>SyncHook：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// packages/hooks/src/syncHook.ts</span><br><span class="line">export class SyncHook&lt;T, K&gt; &#123;</span><br><span class="line">  public type: string = &apos;&apos;;</span><br><span class="line">  public listeners = new Set&lt;Callback&lt;T, K&gt;&gt;();</span><br><span class="line"></span><br><span class="line">  constructor(type?: string) &#123;</span><br><span class="line">    if (type) this.type = type;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  on(fn: Callback&lt;T, K&gt;) &#123;</span><br><span class="line">    if (typeof fn === &apos;function&apos;) &#123;</span><br><span class="line">      this.listeners.add(fn);</span><br><span class="line">    &#125; else if (__DEV__) &#123;</span><br><span class="line">      warn(&apos;Invalid parameter in &quot;Hook&quot;.&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  once(fn: Callback&lt;T, K&gt;) &#123;</span><br><span class="line">    const self = this;</span><br><span class="line">    this.on(function wrapper(...args: Array&lt;any&gt;) &#123;</span><br><span class="line">      self.remove(wrapper);</span><br><span class="line">      return fn.apply(null, args);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  emit(...data: ArgsType&lt;T&gt;) &#123;</span><br><span class="line">    if (this.listeners.size &gt; 0) &#123;</span><br><span class="line">      this.listeners.forEach((fn) =&gt; fn.apply(null, data));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  remove(fn: Callback&lt;T, K&gt;) &#123;</span><br><span class="line">    return this.listeners.delete(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeAll() &#123;</span><br><span class="line">    this.listeners.clear();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>就是一个简单的发布订阅模式。<br>AsyncHook：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// packages/hooks/src/asyncHook.ts</span><br><span class="line">export class AsyncHook&lt;T, K&gt; extends SyncHook&lt;T, K&gt; &#123;</span><br><span class="line">  emit(...data: ArgsType&lt;T&gt;): Promise&lt;void | false&gt; &#123;</span><br><span class="line">    let result;</span><br><span class="line">    const ls = Array.from(this.listeners);</span><br><span class="line">    if (ls.length &gt; 0) &#123;</span><br><span class="line">      let i = 0;</span><br><span class="line">      const call = (prev?: any) =&gt; &#123;</span><br><span class="line">        if (prev === false) &#123;</span><br><span class="line">          return false; // Abort process</span><br><span class="line">        &#125; else if (i &lt; ls.length) &#123;</span><br><span class="line">          return Promise.resolve(ls[i++].apply(null, data)).then(call);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      result = call();</span><br><span class="line">    &#125;</span><br><span class="line">    return Promise.resolve(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>AsyncHook的emit实现，可以理解将一串的异步函数，进行同步处理，上一个异步函数的返回，是下一个异步函数的入参，如果看过Koa中间件的实现，就很容易明白这样逻辑的实现了。<br>到目前为止，当主应用引入Garfish后，初步的注册工作基本完成了。</p><h1 id="主应用中启动Garfish"><a href="#主应用中启动Garfish" class="headerlink" title="主应用中启动Garfish"></a>主应用中启动Garfish</h1><p>我们先假设主应用默认路由就是/，不默认展示子应用。<br>再看主应用如何进行下一步的：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// main/src/index.ts</span><br><span class="line">import GarfishInstance from &apos;garfish&apos;; </span><br><span class="line">import &#123; Config &#125; from &apos;./config&apos;;</span><br><span class="line"></span><br><span class="line">GarfishInstance.run(Config);</span><br><span class="line">第一行代码，我们已经在上面介绍过了，继续往下走，看看Config是什么：</span><br><span class="line">// dev/main/src/config.ts</span><br><span class="line">let defaultConfig: interfaces.Options = &#123;</span><br><span class="line">  basename: &apos;/garfish_master&apos;,</span><br><span class="line">  domGetter: () =&gt; &#123;</span><br><span class="line">    // await asyncTime();</span><br><span class="line">    return document.querySelector(&apos;#submoduleByRouter&apos;);</span><br><span class="line">  &#125;,</span><br><span class="line">  apps: [</span><br><span class="line">    // &#123;</span><br><span class="line">    //   name: &apos;vue&apos;,</span><br><span class="line">    //   activeWhen: &apos;/vue&apos;,</span><br><span class="line">    //   cache: false,</span><br><span class="line">    //   entry: &apos;http://localhost:2666&apos;,</span><br><span class="line">    // &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: &apos;vue2&apos;,</span><br><span class="line">      cache: false,</span><br><span class="line">      activeWhen: &apos;/vue2&apos;,</span><br><span class="line">      entry: &apos;http://localhost:2777&apos;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: &apos;react&apos;,</span><br><span class="line">      activeWhen: &apos;/react&apos;,</span><br><span class="line">      entry: &apos;http://localhost:2444&apos;,</span><br><span class="line">      props: &#123;</span><br><span class="line">        appName: &apos;react&apos;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  autoRefreshApp: false,</span><br><span class="line">  disablePreloadApp: true,</span><br><span class="line">  protectVariable: [&apos;MonitoringInstance&apos;, &apos;Garfish&apos;],</span><br><span class="line">  sandbox: &#123;</span><br><span class="line">    open: true,</span><br><span class="line">    // strictIsolation: true,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  // beforeMount(appInfo) &#123;</span><br><span class="line">  //   console.log(&apos;beforeMount&apos;, appInfo);</span><br><span class="line">  // &#125;,</span><br><span class="line"></span><br><span class="line">  // afterLoad(info, app) &#123;</span><br><span class="line">  //   console.log(app.vmSandbox);</span><br><span class="line">  // &#125;,</span><br><span class="line"></span><br><span class="line">  customLoader() &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>这个默认配置，是用户可以自定义的，通过之前的源码分析，这些配置最后会深度merge到Garfish类中的默认配置。接下来就是GarfishInstance.run(Config)，将配置传入，然后执行Garfish类中的run方法。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/garfish.ts</span><br><span class="line">run(options: interfaces.Options = &#123;&#125;) &#123;</span><br><span class="line">    if (this.running) &#123;</span><br><span class="line">      // ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.setOptions(options);</span><br><span class="line">    // Register plugins</span><br><span class="line">    this.usePlugin(GarfishHMRPlugin());</span><br><span class="line">    this.usePlugin(GarfishPerformance());</span><br><span class="line">    if (!this.options.disablePreloadApp) &#123;</span><br><span class="line">      this.usePlugin(GarfishPreloadPlugin());</span><br><span class="line">    &#125;</span><br><span class="line">    options.plugins?.forEach((plugin) =&gt; this.usePlugin(plugin));</span><br><span class="line">    // Put the lifecycle plugin at the end, so that you can get the changes of other plugins</span><br><span class="line">    this.usePlugin(GarfishOptionsLife(this.options, &apos;global-lifecycle&apos;));</span><br><span class="line"></span><br><span class="line">    // Emit hooks and register apps</span><br><span class="line">    this.hooks.lifecycle.beforeBootstrap.emit(this.options);</span><br><span class="line">    this.registerApp(this.options.apps || []);</span><br><span class="line">    this.running = true;</span><br><span class="line">    this.hooks.lifecycle.bootstrap.emit(this.options);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>首先还是把传入的options参数深度merge到Garfish默认的options中，接着进行一些插件注册，最后注册了一个名为global-lifecycle的插件，这个插件主要是用来兜底的，因为插件注册是有先后顺序的，先注册的插件，在实行生命钩子方法时，是先执行的，所以global-lifecycle这个插件中，传入的生命周期钩子方法是用户可以自定义传入的，那么最后执行的时候，global-lifecycle拿到的是所有插件中最后的数据，方便调试。<br>接下来就是触发生命周期中beforeBootstrap，之前所有的插件中，所有beforeBootstrap的钩子都注册到了全局beforeBootstrap中，这个时候进行emit操作。如果用户没有传入自定义plugin(已经定义了beforeBootstrap方法)的话，这里应该是没有可执行方法的，因为框架内置的一些插件中没有该方法。<br>接下来就是注册app了，我们在主应用中的options中，有个apps的属性，里面注册着所有子应用。看一下registreApp的实现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/garfish.ts</span><br><span class="line">registerApp(list: interfaces.AppInfo | Array&lt;interfaces.AppInfo&gt;) &#123;</span><br><span class="line">    const currentAdds = &#123;&#125;;</span><br><span class="line">    this.hooks.lifecycle.beforeRegisterApp.emit(list);</span><br><span class="line">    if (!Array.isArray(list)) list = [list];</span><br><span class="line"></span><br><span class="line">    for (const appInfo of list) &#123;</span><br><span class="line">      assert(appInfo.name, &apos;Miss app.name.&apos;);</span><br><span class="line">      if (!this.appInfos[appInfo.name]) &#123;</span><br><span class="line">        assert(</span><br><span class="line">          appInfo.entry,</span><br><span class="line">          `$&#123;appInfo.name&#125; application entry is not url: $&#123;appInfo.entry&#125;`,</span><br><span class="line">        );</span><br><span class="line">        currentAdds[appInfo.name] = appInfo;</span><br><span class="line">        this.appInfos[appInfo.name] = appInfo;</span><br><span class="line">      &#125; else if (__DEV__) &#123;</span><br><span class="line">        warn(`The &quot;$&#123;appInfo.name&#125;&quot; app is already registered.`);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    this.hooks.lifecycle.registerApp.emit(currentAdds);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>首先执行生命周期beforeRegisterApp中的方法，然后将apps注册到currentAdds和this.appInfos中，再执行registerApp中的方法。<br>再返回到run方法中，继续往下执行，就会执行生命周期bootstrap中的方法。我们主要看一下router中的bootstrap方法，看看在启动时做了什么<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">// packages/router/src/index.ts</span><br><span class="line">bootstrap(options: interfaces.Options) &#123;</span><br><span class="line">        let activeApp = null;</span><br><span class="line">        const unmounts: Record&lt;string, Function&gt; = &#123;&#125;;</span><br><span class="line">        const &#123; basename &#125; = options;</span><br><span class="line">        const &#123; autoRefreshApp = true, onNotMatchRouter = () =&gt; null &#125; =</span><br><span class="line">          Garfish.options;</span><br><span class="line"></span><br><span class="line">        async function active(appInfo: interfaces.AppInfo, rootPath: string) &#123;</span><br><span class="line">          const &#123; name, cache = true, active &#125; = appInfo;</span><br><span class="line">          if (active) return active(appInfo, rootPath);</span><br><span class="line">          appInfo.rootPath = rootPath;</span><br><span class="line"></span><br><span class="line">          const currentApp = (activeApp = createKey());</span><br><span class="line">          const app = await Garfish.loadApp(appInfo.name, &#123;</span><br><span class="line">            basename: rootPath,</span><br><span class="line">            entry: appInfo.entry,</span><br><span class="line">            cache: true,</span><br><span class="line">            domGetter: appInfo.domGetter,</span><br><span class="line">          &#125;);</span><br><span class="line">          app.appInfo.basename = rootPath;</span><br><span class="line"></span><br><span class="line">          const call = (app: interfaces.App, isRender: boolean) =&gt; &#123;</span><br><span class="line">            if (!app) return;</span><br><span class="line">            const isDes = cache &amp;&amp; app.mounted;</span><br><span class="line">            const fn = isRender</span><br><span class="line">              ? app[isDes ? &apos;show&apos; : &apos;mount&apos;]</span><br><span class="line">              : app[isDes ? &apos;hide&apos; : &apos;unmount&apos;];</span><br><span class="line">            return fn.call(app);</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          Garfish.apps[name] = app;</span><br><span class="line">          unmounts[name] = () =&gt; call(app, false);</span><br><span class="line"></span><br><span class="line">          if (currentApp === activeApp) &#123;</span><br><span class="line">            await call(app, true);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        async function deactive(appInfo: interfaces.AppInfo, rootPath: string) &#123;</span><br><span class="line">          activeApp = null;</span><br><span class="line">          const &#123; name, deactive &#125; = appInfo;</span><br><span class="line">          if (deactive) return deactive(appInfo, rootPath);</span><br><span class="line"></span><br><span class="line">          const unmount = unmounts[name];</span><br><span class="line">          unmount &amp;&amp; unmount();</span><br><span class="line">          delete Garfish.apps[name];</span><br><span class="line"></span><br><span class="line">          // Nested scene to remove the current application of nested data</span><br><span class="line">          // To avoid the main application prior to application</span><br><span class="line">          const needToDeleteApps = router.routerConfig.apps.filter((app) =&gt; &#123;</span><br><span class="line">            if (appInfo.rootPath === app.basename) return true;</span><br><span class="line">          &#125;);</span><br><span class="line">          if (needToDeleteApps.length &gt; 0) &#123;</span><br><span class="line">            needToDeleteApps.forEach((app) =&gt; &#123;</span><br><span class="line">              delete Garfish.appInfos[app.name];</span><br><span class="line">              delete Garfish.cacheApps[app.name];</span><br><span class="line">            &#125;);</span><br><span class="line">            router.setRouterConfig(&#123;</span><br><span class="line">              apps: router.routerConfig.apps.filter((app) =&gt; &#123;</span><br><span class="line">                return !needToDeleteApps.some(</span><br><span class="line">                  (needDelete) =&gt; app.name === needDelete.name,</span><br><span class="line">                );</span><br><span class="line">              &#125;),</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        const apps = Object.values(Garfish.appInfos);</span><br><span class="line"></span><br><span class="line">        const appList = apps.filter((app) =&gt; &#123;</span><br><span class="line">          if (!app.basename) app.basename = basename;</span><br><span class="line">          return !!app.activeWhen;</span><br><span class="line">        &#125;) as Array&lt;Required&lt;interfaces.AppInfo&gt;&gt;;</span><br><span class="line"></span><br><span class="line">        const listenOptions = &#123;</span><br><span class="line">          basename,</span><br><span class="line">          active,</span><br><span class="line">          deactive,</span><br><span class="line">          autoRefreshApp,</span><br><span class="line">          notMatch: onNotMatchRouter,</span><br><span class="line">          apps: appList,</span><br><span class="line">        &#125;;</span><br><span class="line">        listenRouterAndReDirect(listenOptions);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p></p><p>这个方法可以直接看最后，就是执行了一个listenRouterAndReDirect方法，并传入了listenOptions对象。接着找listenRouterAndReDirect方法的实现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// packages/router/src/context.ts</span><br><span class="line">export const listenRouterAndReDirect = (&#123;</span><br><span class="line">  apps,</span><br><span class="line">  basename,</span><br><span class="line">  autoRefreshApp,</span><br><span class="line">  active,</span><br><span class="line">  deactive,</span><br><span class="line">  notMatch,</span><br><span class="line">&#125;: Options) =&gt; &#123;</span><br><span class="line">  // 注册子应用、注册激活、销毁钩子</span><br><span class="line">  registerRouter(apps);</span><br><span class="line"></span><br><span class="line">  // 初始化信息</span><br><span class="line">  setRouterConfig(&#123;</span><br><span class="line">    basename,</span><br><span class="line">    autoRefreshApp,</span><br><span class="line">    // supportProxy: !!window.Proxy,</span><br><span class="line">    active,</span><br><span class="line">    deactive,</span><br><span class="line">    notMatch,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // 开始监听路由变化触发、子应用更新。重载默认初始子应用</span><br><span class="line">  listen();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>主要就是注册子应用，初始化配置，最后进行监听。再看listen方法的实现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// packages/router/src/agentRouter.ts</span><br><span class="line">export const listen = () =&gt; &#123;</span><br><span class="line">  normalAgent();</span><br><span class="line">  initRedirect();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>然后执行了两个方法normalAgent和initRedirect，继续往下看实现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">// packages/router/src/agentRouter.ts</span><br><span class="line">export const normalAgent = () =&gt; &#123;</span><br><span class="line">  // By identifying whether have finished listening, if finished listening, listening to the routing changes do not need to hijack the original event</span><br><span class="line">  // Support nested scene</span><br><span class="line">  const addRouterListener = function () &#123;</span><br><span class="line">    window.addEventListener(__GARFISH_BEFORE_ROUTER_EVENT__, function (env) &#123;</span><br><span class="line">      RouterConfig.routerChange &amp;&amp; RouterConfig.routerChange(location.pathname);</span><br><span class="line">      linkTo((env as any).detail);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  if (!window[__GARFISH_ROUTER_FLAG__]) &#123;</span><br><span class="line">    // Listen for pushState and replaceState, call linkTo, processing, listen back</span><br><span class="line">    // Rewrite the history API method, triggering events in the call</span><br><span class="line">    const rewrite = function (type: keyof History) &#123;</span><br><span class="line">      const hapi = history[type];</span><br><span class="line">      return function () &#123;</span><br><span class="line">        const urlBefore = window.location.pathname + window.location.hash;</span><br><span class="line">        const stateBefore = history?.state;</span><br><span class="line">        const res = hapi.apply(this as any, arguments);</span><br><span class="line">        const urlAfter = window.location.pathname + window.location.hash;</span><br><span class="line">        const stateAfter = history?.state;</span><br><span class="line"></span><br><span class="line">        const e = createEvent(type);</span><br><span class="line">        (e as any).arguments = arguments;</span><br><span class="line"></span><br><span class="line">        if (urlBefore !== urlAfter || stateBefore !== stateAfter) &#123;</span><br><span class="line">          if (history.state &amp;&amp; history.state === &apos;object&apos;)</span><br><span class="line">            delete history.state[__GARFISH_ROUTER_UPDATE_FLAG__];</span><br><span class="line">          window.dispatchEvent(</span><br><span class="line">            new CustomEvent(__GARFISH_BEFORE_ROUTER_EVENT__, &#123;</span><br><span class="line">              detail: &#123;</span><br><span class="line">                toRouterInfo: &#123;</span><br><span class="line">                  fullPath: urlAfter,</span><br><span class="line">                  query: parseQuery(location.search),</span><br><span class="line">                  path: getPath(RouterConfig.basename!, urlAfter),</span><br><span class="line">                  state: stateAfter,</span><br><span class="line">                &#125;,</span><br><span class="line">                fromRouterInfo: &#123;</span><br><span class="line">                  fullPath: urlBefore,</span><br><span class="line">                  query: parseQuery(location.search),</span><br><span class="line">                  path: getPath(RouterConfig.basename!, urlBefore),</span><br><span class="line">                  state: stateBefore,</span><br><span class="line">                &#125;,</span><br><span class="line">                eventType: type,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;),</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">        // window.dispatchEvent(e);</span><br><span class="line">        return res;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    history.pushState = rewrite(&apos;pushState&apos;);</span><br><span class="line">    history.replaceState = rewrite(&apos;replaceState&apos;);</span><br><span class="line"></span><br><span class="line">    // Before the collection application sub routing, forward backward routing updates between child application</span><br><span class="line">    window.addEventListener(</span><br><span class="line">      &apos;popstate&apos;,</span><br><span class="line">      function (event) &#123;</span><br><span class="line">        // Stop trigger collection function, fire again match rendering</span><br><span class="line">        if (event &amp;&amp; typeof event === &apos;object&apos; &amp;&amp; (event as any).garfish)</span><br><span class="line">          return;</span><br><span class="line">        if (history.state &amp;&amp; history.state === &apos;object&apos;)</span><br><span class="line">          delete history.state[__GARFISH_ROUTER_UPDATE_FLAG__];</span><br><span class="line">        window.dispatchEvent(</span><br><span class="line">          new CustomEvent(__GARFISH_BEFORE_ROUTER_EVENT__, &#123;</span><br><span class="line">            detail: &#123;</span><br><span class="line">              toRouterInfo: &#123;</span><br><span class="line">                fullPath: location.pathname,</span><br><span class="line">                query: parseQuery(location.search),</span><br><span class="line">                path: getPath(RouterConfig.basename!),</span><br><span class="line">              &#125;,</span><br><span class="line">              fromRouterInfo: &#123;</span><br><span class="line">                fullPath: RouterConfig.current!.fullPath,</span><br><span class="line">                path: getPath(</span><br><span class="line">                  RouterConfig.basename!,</span><br><span class="line">                  RouterConfig.current!.path,</span><br><span class="line">                ),</span><br><span class="line">                query: RouterConfig.current!.query,</span><br><span class="line">              &#125;,</span><br><span class="line">              eventType: &apos;popstate&apos;,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;),</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">      false,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    window[__GARFISH_ROUTER_FLAG__] = true;</span><br><span class="line">  &#125;</span><br><span class="line">  addRouterListener();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>normalAgent方法的实现，其实就是重写了history.pushState和history.replaceState两个方法，并且会触发一个自定义事件<strong>GARFISH_BEFORE_ROUTER_EVENT</strong>，那么addRouterListener其实就是注册了<strong>GARFISH_BEFORE_ROUTER_EVENT</strong>自定义事件。而initRedirect方法就是初始默认化路由的。无论是normalAgent还是initRedirect，最后都会进入linkTo方法：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">// packages/router/src/linkTo.ts</span><br><span class="line">export const linkTo = async (&#123;</span><br><span class="line">  toRouterInfo,</span><br><span class="line">  fromRouterInfo,</span><br><span class="line">  eventType,</span><br><span class="line">&#125;: &#123;</span><br><span class="line">  toRouterInfo: RouterInfo;</span><br><span class="line">  fromRouterInfo: RouterInfo;</span><br><span class="line">  eventType: keyof History | &apos;popstate&apos;;</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">  const &#123;</span><br><span class="line">    current,</span><br><span class="line">    apps,</span><br><span class="line">    deactive,</span><br><span class="line">    active,</span><br><span class="line">    notMatch,</span><br><span class="line">    beforeEach,</span><br><span class="line">    afterEach,</span><br><span class="line">    autoRefreshApp,</span><br><span class="line">  &#125; = RouterConfig;</span><br><span class="line">  const deactiveApps = current!.matched.filter(</span><br><span class="line">    (appInfo) =&gt;</span><br><span class="line">      !hasActive(</span><br><span class="line">        appInfo.activeWhen,</span><br><span class="line">        getPath(appInfo.basename, location.pathname),</span><br><span class="line">      ),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  // Activate the corresponding application</span><br><span class="line">  const activeApps = apps.filter((appInfo) =&gt; &#123;</span><br><span class="line">    return hasActive(</span><br><span class="line">      appInfo.activeWhen,</span><br><span class="line">      getPath(appInfo.basename, location.pathname),</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  const needToActive = activeApps.filter((&#123; name &#125;) =&gt; &#123;</span><br><span class="line">    return !current!.matched.some((&#123; name: cName &#125;) =&gt; name === cName);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // router infos</span><br><span class="line">  const to = &#123;</span><br><span class="line">    ...toRouterInfo,</span><br><span class="line">    matched: needToActive,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  const from = &#123;</span><br><span class="line">    ...fromRouterInfo,</span><br><span class="line">    matched: deactiveApps,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  await toMiddleWare(to, from, beforeEach!);</span><br><span class="line"></span><br><span class="line">  // Pause the current application of active state</span><br><span class="line">  if (current!.matched.length &gt; 0) &#123;</span><br><span class="line">    await asyncForEach(</span><br><span class="line">      deactiveApps,</span><br><span class="line">      async (appInfo) =&gt;</span><br><span class="line">        await deactive(appInfo, getPath(appInfo.basename, location.pathname)),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setRouterConfig(&#123;</span><br><span class="line">    current: &#123;</span><br><span class="line">      path: getPath(RouterConfig.basename!),</span><br><span class="line">      fullPath: location.pathname,</span><br><span class="line">      matched: activeApps,</span><br><span class="line">      state: history.state,</span><br><span class="line">      query: parseQuery(location.search),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // Within the application routing jump, by collecting the routing function for processing.</span><br><span class="line">  // Filtering gar-router popstate hijacking of the router</span><br><span class="line">  // In the switch back and forth in the application is provided through routing push method would trigger application updates</span><br><span class="line">  // application will refresh when autoRefresh configuration to true</span><br><span class="line">  const curState = window.history.state || &#123;&#125;;</span><br><span class="line">  if (</span><br><span class="line">    eventType !== &apos;popstate&apos; &amp;&amp;</span><br><span class="line">    (curState[__GARFISH_ROUTER_UPDATE_FLAG__] || autoRefreshApp)</span><br><span class="line">  ) &#123;</span><br><span class="line">    callCapturedEventListeners(eventType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  await asyncForEach(needToActive, async (appInfo) =&gt; &#123;</span><br><span class="line">    // Function using matches character and routing using string matching characters</span><br><span class="line">    const appRootPath = getAppRootPath(appInfo);</span><br><span class="line">    await active(appInfo, appRootPath);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  if (activeApps.length === 0 &amp;&amp; notMatch) notMatch(location.pathname);</span><br><span class="line"></span><br><span class="line">  await toMiddleWare(to, from, afterEach!);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>再归纳一下，有两个中间件可以执行，afterEach和beforeEach，就是在active之前和之后的执行时机。然后主要的就是active了，其实active这个方法，是router插件中，bootstrap钩子里的active方法。到目前为止，我们主应用就run起来了，接下来就是通过路由来show或者hide子应用了。</p><h1 id="路由trigger子应用"><a href="#路由trigger子应用" class="headerlink" title="路由trigger子应用"></a>路由trigger子应用</h1><p>接下来点击vue按钮，展示vue子应用。<br>我们前面已经介绍过了，在normalAgent实现中劫持了history.push方法，那么在进行路由变化时，就会触发自定义事件<strong>GARFISH_BEFORE_ROUTER_EVENT</strong>，然后会再次进入linkTo方法，这个时候needToActive就是true了，会执行active，而active就是router插件中bootstrap的active方法：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// packages/router/src/index.ts</span><br><span class="line">async function active(appInfo: interfaces.AppInfo, rootPath: string) &#123;</span><br><span class="line">          const &#123; name, cache = true, active &#125; = appInfo;</span><br><span class="line">          if (active) return active(appInfo, rootPath);</span><br><span class="line">          appInfo.rootPath = rootPath;</span><br><span class="line"></span><br><span class="line">          const currentApp = (activeApp = createKey());</span><br><span class="line">          const app = await Garfish.loadApp(appInfo.name, &#123;</span><br><span class="line">            basename: rootPath,</span><br><span class="line">            entry: appInfo.entry,</span><br><span class="line">            cache: true,</span><br><span class="line">            domGetter: appInfo.domGetter,</span><br><span class="line">          &#125;);</span><br><span class="line">          app.appInfo.basename = rootPath;</span><br><span class="line"></span><br><span class="line">          const call = (app: interfaces.App, isRender: boolean) =&gt; &#123;</span><br><span class="line">            if (!app) return;</span><br><span class="line">            const isDes = cache &amp;&amp; app.mounted;</span><br><span class="line">            const fn = isRender</span><br><span class="line">              ? app[isDes ? &apos;show&apos; : &apos;mount&apos;]</span><br><span class="line">              : app[isDes ? &apos;hide&apos; : &apos;unmount&apos;];</span><br><span class="line">            return fn.call(app);</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          Garfish.apps[name] = app;</span><br><span class="line">          unmounts[name] = () =&gt; call(app, false);</span><br><span class="line"></span><br><span class="line">          if (currentApp === activeApp) &#123;</span><br><span class="line">            await call(app, true);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p></p><p>这个方法中会有个app，这个app是Garfish类中loadApp方法返回的，那我们看一下返回的这个app是啥：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/garfish.ts</span><br><span class="line">async loadApp(</span><br><span class="line">    appName: string,</span><br><span class="line">    optionsOrUrl?: Omit&lt;interfaces.AppInfo, &apos;name&apos;&gt;,</span><br><span class="line">  ): Promise&lt;interfaces.App | null&gt; &#123;</span><br><span class="line">    assert(appName, &apos;Miss appName.&apos;);</span><br><span class="line">    const appInfo = generateAppOptions(appName, this, optionsOrUrl);</span><br><span class="line"></span><br><span class="line">    const asyncLoadProcess = async () =&gt; &#123;</span><br><span class="line">      // Return not undefined type data directly to end loading</span><br><span class="line">      const stop = await this.hooks.lifecycle.beforeLoad.emit(appInfo);</span><br><span class="line">      if (stop === false) &#123;</span><br><span class="line">        warn(`Load $&#123;appName&#125; application is terminated by beforeLoad.`);</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">      // Existing cache caching logic</span><br><span class="line">      let appInstance: interfaces.App = null;</span><br><span class="line">      const cacheApp = this.cacheApps[appName];</span><br><span class="line">      if (appInfo.cache &amp;&amp; cacheApp) &#123;</span><br><span class="line">        appInstance = cacheApp;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          const [manager, resources, isHtmlMode] = await processAppResources(</span><br><span class="line">            this.loader,</span><br><span class="line">            appInfo,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">          appInstance = new App(</span><br><span class="line">            this,</span><br><span class="line">            appInfo,</span><br><span class="line">            manager,</span><br><span class="line">            resources,</span><br><span class="line">            isHtmlMode,</span><br><span class="line">            appInfo.customLoader,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">          // The registration hook will automatically remove the duplication</span><br><span class="line">          for (const key in this.plugins) &#123;</span><br><span class="line">            appInstance.hooks.usePlugin(this.plugins[key]);</span><br><span class="line">          &#125;</span><br><span class="line">          if (appInfo.cache) &#123;</span><br><span class="line">            this.cacheApps[appName] = appInstance;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">          __DEV__ &amp;&amp; warn(e);</span><br><span class="line">          this.hooks.lifecycle.errorLoadApp.emit(e, appInfo);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      await this.hooks.lifecycle.afterLoad.emit(appInfo, appInstance);</span><br><span class="line">      return appInstance;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    if (!this.loading[appName]) &#123;</span><br><span class="line">      this.loading[appName] = asyncLoadProcess().finally(() =&gt; &#123;</span><br><span class="line">        this.loading[appName] = null;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    return this.loading[appName];</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>这个函数稍微有点长，我总结一下，this.loading是为了保存当前要加载的app，通过一个asyncLoadProcess返回，这里注意一下，asyncLoadProcess是async函数，没有await，所以返回的是一个Promise对象，而resolve的是appInstance，在asyncLoadProcess中，也是执行了app生命周期中的几个钩子。我们再简单了解一下App类是什么样的，由于代码太多，我们只列个大概，并且说明用途即可：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/module/app.ts</span><br><span class="line">export class App &#123;</span><br><span class="line">  public appId = appId++;</span><br><span class="line">  public display = false;</span><br><span class="line">  public mounted = false;</span><br><span class="line">  public esModule = false;</span><br><span class="line">  public strictIsolation = false;</span><br><span class="line">  public name: string;</span><br><span class="line">  public isHtmlMode: boolean;</span><br><span class="line">  public global: any = window;</span><br><span class="line">  public appContainer: HTMLElement;</span><br><span class="line">  public cjsModules: Record&lt;string, any&gt;;</span><br><span class="line">  public htmlNode: HTMLElement | ShadowRoot;</span><br><span class="line">  public customExports: Record&lt;string, any&gt; = &#123;&#125;; // If you don&apos;t want to use the CJS export, can use this</span><br><span class="line">  public sourceList: Array&lt;&#123; tagName: string; url: string &#125;&gt; = [];</span><br><span class="line">  public appInfo: AppInfo;</span><br><span class="line">  public hooks: interfaces.AppHooks;</span><br><span class="line">  public provider: interfaces.Provider;</span><br><span class="line">  public entryManager: TemplateManager;</span><br><span class="line">  public appPerformance: SubAppObserver;</span><br><span class="line">  /** @deprecated */</span><br><span class="line">  public customLoader: CustomerLoader;</span><br><span class="line"></span><br><span class="line">  private active = false;</span><br><span class="line">  private mounting = false;</span><br><span class="line">  private unmounting = false;</span><br><span class="line">  private context: Garfish;</span><br><span class="line">  private resources: interfaces.ResourceModules;</span><br><span class="line">  // Environment variables injected by garfish for linkage with child applications</span><br><span class="line">  private globalEnvVariables: Record&lt;string, any&gt;;</span><br><span class="line">  // es-module save lifeCycle to appGlobalId，appGlobalId in script attr</span><br><span class="line">  private appGlobalId: string;</span><br><span class="line"></span><br><span class="line">  constructor(</span><br><span class="line">    context: Garfish,</span><br><span class="line">    appInfo: AppInfo,</span><br><span class="line">    entryManager: TemplateManager,</span><br><span class="line">    resources: interfaces.ResourceModules,</span><br><span class="line">    isHtmlMode: boolean,</span><br><span class="line">    customLoader: CustomerLoader,</span><br><span class="line">  ) &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get rootElement() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getProvider() &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  execScript(</span><br><span class="line">    code: string,</span><br><span class="line">    env: Record&lt;string, any&gt;,</span><br><span class="line">    url?: string,</span><br><span class="line">    options?: &#123; async?: boolean; noEntry?: boolean &#125;,</span><br><span class="line">  ) &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // `vm sandbox` can override this method</span><br><span class="line">  runCode(</span><br><span class="line">    code: string,</span><br><span class="line">    env: Record&lt;string, any&gt;,</span><br><span class="line">    url?: string,</span><br><span class="line">    options?: &#123; async?: boolean; noEntry?: boolean &#125;,</span><br><span class="line">  ) &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  async show() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hide() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  async mount() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unmount() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getExecScriptEnv(noEntry: boolean) &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Performs js resources provided by the module, finally get the content of the export</span><br><span class="line">  async compileAndRenderContainer() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private canMount() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // If asynchronous task encountered in the rendering process, such as triggering the beforeEval before executing code,</span><br><span class="line">  // after the asynchronous task, you need to determine whether the application has been destroyed or in the end state.</span><br><span class="line">  // If in the end state will need to perform the side effects of removing rendering process, adding a mount point to a document,</span><br><span class="line">  // for example, execute code of the environmental effects, and rendering the state in the end.</span><br><span class="line">  private stopMountAndClearEffect() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Calls to render do compatible with two different sandbox</span><br><span class="line">  private callRender(provider: interfaces.Provider, isMount: boolean) &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Call to destroy do compatible with two different sandbox</span><br><span class="line">  private callDestroy(provider: interfaces.Provider, isUnmount: boolean) &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Create a container node and add in the document flow</span><br><span class="line">  // domGetter Have been dealing with</span><br><span class="line">  private async addContainer() &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private async renderTemplate() &#123;</span><br><span class="line">     // ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private async checkAndGetProvider() &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>总结起来，这个App类提供的能力如下：</p><ol><li>提供静态资源，HTML、CSS、js的结构。</li><li>可以在CJS中提取或者推导出子应用的 provider。<br>3.通过execCode传入模块的CJS规范、require、exports等环境变量实现对外共享</li><li>触发渲染：应用相关节点放置在文档流中，依次执行应用脚本，最终渲染功能，执行子应用提供完整的应用独立运行时执行。</li><li>触发销毁：执行子应用程序的销毁功能，应用子节点从文档流中移除。<br>再回到active方法中，最核心的地方是call方法，最后调用了App中的show、mount、hide、unmount方法。show和hide可以理解为之前已经加载过了，就是show和hide一下，mount是要和unmount是挂载和卸载，我们这里主要以mount为例，看一下是如何加载子应用环境并且加载子应用的。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// packages/core/src/module/app.ts</span><br><span class="line">async mount() &#123;</span><br><span class="line">    if (!this.canMount()) return false;</span><br><span class="line">    this.hooks.lifecycle.beforeMount.emit(this.appInfo, this, false);</span><br><span class="line"></span><br><span class="line">    this.active = true;</span><br><span class="line">    this.mounting = true;</span><br><span class="line">    try &#123;</span><br><span class="line">      // add container and compile js with cjs</span><br><span class="line">      const asyncJsProcess = await this.compileAndRenderContainer();</span><br><span class="line"></span><br><span class="line">      // Good provider is set at compile time</span><br><span class="line">      const provider = await this.getProvider();</span><br><span class="line">      // Existing asynchronous functions need to decide whether the application has been unloaded</span><br><span class="line">      if (!this.stopMountAndClearEffect()) return false;</span><br><span class="line"></span><br><span class="line">      this.callRender(provider, true);</span><br><span class="line">      this.display = true;</span><br><span class="line">      this.mounted = true;</span><br><span class="line">      this.context.activeApps.push(this);</span><br><span class="line">      this.hooks.lifecycle.afterMount.emit(this.appInfo, this, false);</span><br><span class="line"></span><br><span class="line">      await asyncJsProcess;</span><br><span class="line">      if (!this.stopMountAndClearEffect()) return false;</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      this.entryManager.DOMApis.removeElement(this.appContainer);</span><br><span class="line">      this.hooks.lifecycle.errorMountApp.emit(e, this.appInfo);</span><br><span class="line">      return false;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      this.mounting = false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ol><p>大概意思就是说，添加了一个子应用容器，拿到子应用资源（主要通过fetch方式获取，继续深挖compileAndRenderContainer就知道了），然后获取子应用export出来的provider，最后执行代码，子应用就成功展示出来了。<br>再说一下子应用的代码执行，子应用中如果使用了window，那么在子应用接入主应用后，如果不做任何处理，那么两个应用的window是一个，这样就会有逻辑问题，为了解决这个问题，就有了沙箱概念。garfish中提供了两种沙箱机制：vm沙箱和snapshot沙箱。<br>我们可以看一个简单的vm沙箱原理：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const varBox = &#123;&#125;;</span><br><span class="line">const fakeWindow = new Proxy(window, &#123;</span><br><span class="line">    get(target, key) &#123;</span><br><span class="line">        return varBox[key] || window[key]</span><br><span class="line">    &#125;,</span><br><span class="line">    set(target, key, value) &#123;</span><br><span class="line">        varBox[key] = value;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">const fn = new Function(&apos;window&apos;, code);</span><br><span class="line">fn(fakeWindow);</span><br></pre></td></tr></table></figure><p></p><p>主要是通过es6中proxy实现的，当然这只是一个原理性代码，实际中还会兼容很多case。其实在最初注册garfish插件的时候，初始化garfish实例的时候，就初始化了vm沙箱和snapshot沙箱。我们前面也说了，在每个插件中都会定义一些生命周期的钩子方法，其实在Garfish.loadApp的时候，就在App上挂载了vmSandbox属性，在后续的子应用执行代码时，环境都是在沙箱中执行。</p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"></ul><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://skhon.github.io/2021/12/28/fe/garfish/" title="探索garfish源码" target="_blank" rel="external">https://skhon.github.io/2021/12/28/fe/garfish/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></blockquote></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2021/12/28/fe/typescript/" title="typescript整理"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2021/12/20/architecture/base/" title="架构师的职责"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipay.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/weixin.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation" class=""><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta="nick,mail,link";meta=meta.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"huAiR1yunesf5fNRhXNbEImX-gzGzoHsz",appKey:"VrPyyjDOa1dG6OnbJeKqJUXc",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!0})</script></body></html>