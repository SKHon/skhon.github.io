---
title: 探索一下node的性能瓶颈
date: 2020-06-01 18:10:00
categories: 前端
tags: [node]
comments: true
copyright: true
---

## 背景

这两天自己压测 hobber 框架，想看看 qps 能打到多少。和测试借了一台 cpu 8 核， 内存 32GB 的机器，node 版本 12.8。另外 4 台发压机。压测工具用的 jmeter。<!--more-->

## 裸压 hello world

先裸压 hello world，并发 400，压了 120s。最后结论是 qps 打到 3000 多就上不去了，但是机器 cpu 使用率一直在 25%左右。
![](/images/node_pro/hobber01.png)

![](/images/node_pro/hobber02.png)

后续并发增加到 800，发现 qps 上不去了，cpu 的使用率也上不去了。那么到这里，就有个疑问，qps 为什么压不上去了？cpu 还没打满呀，应该还有空间的呀。到这里，就卡壳了，不知道怎么回事了。

我想了想，因为 hobber 是基于 koa 开发的，那我就想着用直接写一个简单的应用，koa + koa-router + log4js 来大概模拟一个简单的服务，看能不能把 cpu 给压上去。

## 压 koa

还是上述的配置，来压 koa，单核，800 并发，压了 120s，qps 大概能飙到 6000 多，cpu 在 35%左右。看起来是相比 hobber，qps 和 cpu 都压上去一点了，但是还是上述的问题，增加并发，cpu 和 qps 都上不去了，感觉就像到了瓶颈一样。那么这个时候，可以有多种可能，可能是 linux 系统就是这么调度的，单核情况下，你的 cpu 不会给你分配很高的。也可能是 node 的性能瓶颈，并发达到一定程度后，libuv 管理的线程池操作不了这么大的量，就挂起等待了，就是说 node 性能本身就有瓶颈。到这里，问题好想有点难搞了，但是我觉得，要是 node 本身有瓶颈，那应该早有人爆出来了呀。。我反正觉得，应该不是 node 的问题。这个时候，我又想起了一个框架就是 egg，把 egg 也压一下，和 hobber 做个对比。

## 压 egg

配置没变，还是 8 核，32g 内存的配置，先单核裸压 egg，压的结果和 hobber 基本一致，qps3000 多，cpu 在 25%左右，增加并发也上不去了。然后！！我把 egg 多核打开，我的机器 8 核，跑 8 个进程，800 并发开始压，发现 qps 能飙到 1w 左右，cpu 能打到 90%左右。

## 压 node 自带 http 模块

配置依然没变，800 并发，压 http 模块，发现 qps 上去了，能打到近 9k，cpu 只能到 30%。那么，cpu 为什么上不去呢？

## 为什么压测 node 服务系统 cpu 上不去

到这里，其实就有结论了。node 不开 cluster 情况下，单进程单线程，就跑一个 cpu，我们服务所在机器共 8 核，你只跑一个，最多也只把 node 用的这个 cpu 跑满， 这种情况系统 cpu 肯定不会打满的，这就是为什么你 node 服务（未开启 cluster）压测，cpu 一直上不去的原因。

## node 的负载有瓶颈吗

我网上搜了一下 node 负载相关文章，看到这篇：[点这里](https://www.cnblogs.com/cqq626/p/7775196.html) ，我看作者也是压了 koa，他的机器是 48 核，他最后把 48 核都开启了，node 的最后 qps 也最多打到 1w 左右，作者最后给的结论是，http 模块的 qps 最多 1w。

我这个人，就是爱动手。。。我压了 http 模块，机器还是我上面提到的机器，4 台发压机，2000 并能，压 5 分钟，未开启 cluster 情况下，qps 能到近 9k，cpu 在 30%（这里基本可以验证，为什么压测 node 服务系统【单进程】 cpu 上不去 的原因），然后我开启 cluster，qps 能到 14k。。。那这基本可以反驳上述作者的观点了
。最后，我觉得，node 的负载瓶颈肯定是有的，只不过，我目前能拿到的机器，还达不到能压出 node 瓶颈的配置，后续结论，随缘吧。。。
